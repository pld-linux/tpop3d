diff -urN tpop3d-1.5.3.org/ioabs_tcp.c tpop3d-1.5.3/ioabs_tcp.c
--- tpop3d-1.5.3.org/ioabs_tcp.c	2006-06-25 20:16:47.000000000 +0200
+++ tpop3d-1.5.3/ioabs_tcp.c	2006-06-25 20:43:25.000000000 +0200
@@ -82,7 +82,7 @@
     struct ioabs_tcp *io;
     io = (struct ioabs_tcp*)c->io;
 
-    if (pfds[c->s].revents == POLLIN) {
+    if (pfds[c->s].revents & POLLIN) {
         /* Can read data. */
         do {
             char *r;
@@ -111,7 +111,7 @@
         }
     }
 
-    if (pfds[c->s].revents == POLLOUT && buffer_available(c->wrb) > 0) {
+    if (pfds[c->s].revents & POLLOUT && buffer_available(c->wrb) > 0) {
         /* Can write data. */
         n = 1;
         do {
diff -urN tpop3d-1.5.3.org/ioabs_tls.c tpop3d-1.5.3/ioabs_tls.c
--- tpop3d-1.5.3.org/ioabs_tls.c	2006-06-25 20:16:47.000000000 +0200
+++ tpop3d-1.5.3/ioabs_tls.c	2006-06-25 20:43:36.000000000 +0200
@@ -252,8 +252,8 @@
     struct ioabs_tls *io;
     io = (struct ioabs_tls*)c->io;
 
-    canread  = pfds[c->s].revents == POLLIN;
-    canwrite = pfds[c->s].revents == POLLOUT;
+    canread  = pfds[c->s].revents & POLLIN;
+    canwrite = pfds[c->s].revents & POLLOUT;
     
     /* First, accept handling. */
     if ((io->accept_blocked_on_read && canread) || (io->accept_blocked_on_write && canwrite)) {
diff -urN tpop3d-1.5.3.org/netloop.c tpop3d-1.5.3/netloop.c
--- tpop3d-1.5.3.org/netloop.c	2006-06-25 20:16:47.000000000 +0200
+++ tpop3d-1.5.3/netloop.c	2006-06-25 22:26:55.000000000 +0200
@@ -124,7 +124,7 @@
     item *t;
     vector_iterate(listeners, t) {
         listener L = (listener)t->v;
-       if (pfds[L->s].revents == POLLIN) {
+       if (pfds[L->s].revents & POLLIN) {
             struct sockaddr_in sin, sinlocal;
             size_t l = sizeof(sin);
             static int tcp_send_buf = -1;
@@ -550,15 +550,17 @@
     
     /* Main select() loop */
     while (!foad) {
-        int n = 0, e;
+        int n = 0, i, e;
 
        memset(pfds, 0, max_connections * sizeof(struct pollfd));
+       for (i = 0; i < max_connections; i++)
+	       pfds[i].fd = -1;
 
         if (!post_fork) listeners_pre_select(&n, pfds);
 
         connections_pre_select(&n, pfds);
 
-       e = poll(pfds, n + 1, 1000 /* must be smaller than timeout */);
+       e = poll(pfds, n, 1000 /* must be smaller than timeout */);
         if (e == -1 && errno != EINTR) {
             log_print(LOG_WARNING, "net_loop: poll: %m");
         } else if (e >= 0) {
diff -urN tpop3d-1.5.3.org/poll.c tpop3d-1.5.3/poll.c
--- tpop3d-1.5.3.org/poll.c	2006-06-25 20:41:56.000000000 +0200
+++ tpop3d-1.5.3/poll.c	2006-06-25 22:20:47.000000000 +0200
@@ -7,6 +7,10 @@
  *
  */
 
+#ifdef HAVE_CONFIG_H
+#include "configuration.h"
+#endif /* HAVE_CONFIG_H */
+
 #ifndef HAVE_POLL
 
 static const char rcsid[] = "$Id$";
diff -urN tpop3d-1.5.3.org/poll.h tpop3d-1.5.3/poll.h
--- tpop3d-1.5.3.org/poll.h	2006-06-25 20:41:56.000000000 +0200
+++ tpop3d-1.5.3/poll.h	2006-06-25 22:20:54.000000000 +0200
@@ -11,6 +11,10 @@
 #ifndef __POLL_H_ /* include guard */
 #define __POLL_H_
 
+#ifdef HAVE_CONFIG_H
+#include "configuration.h"
+#endif /* HAVE_CONFIG_H */
+
 #ifdef HAVE_POLL
 
 #include <sys/poll.h>
